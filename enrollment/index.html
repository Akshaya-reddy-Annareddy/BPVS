<!DOCTYPE html>
<html>
<head>
    <title>Enrollment</title>
</head>
<body>

<h2>Student Face Enrollment</h2>

<video id="preview" width="400" autoplay muted></video>
<br><br>

<button onclick="startCamera()">Start Camera</button>
<button onclick="startRecording()">Start Recording</button>
<button onclick="stopRecording()">Stop & Upload</button>

<p id="status">Status: Idle</p>

<script>
let mediaRecorder;
let recordedChunks = [];
let stream;

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        document.getElementById("preview").srcObject = stream;
        document.getElementById("status").innerText = "Status: Camera started";
    } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Status: Camera error";
    }
}

function startRecording() {
    if (!stream) {
        alert("Start camera first");
        return;
    }

    recordedChunks = [];

    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = function(event) {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };

    mediaRecorder.onstop = uploadVideo;

    mediaRecorder.start();
    document.getElementById("status").innerText = "Status: Recording...";
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        document.getElementById("status").innerText = "Status: Processing video...";
    } else {
        alert("Recording not started");
    }
}

async function uploadVideo() {
    try {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const file = new File([blob], "enrollment.webm");

        const formData = new FormData();
        formData.append("file", file);

        document.getElementById("status").innerText = "Status: Uploading video...";

        const response = await fetch("https://fictional-space-adventure-975www67xxr427vv5-8000.app.github.dev/upload-video", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            document.getElementById("status").innerText = "Status: Video uploaded successfully ✅";
        } else {
            document.getElementById("status").innerText = "Status: Upload failed ❌";
        }

    } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Status: Error uploading video ❌";
    }
}
</script>

</body>
</html>
